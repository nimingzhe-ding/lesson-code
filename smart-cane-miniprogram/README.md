# 智能拐杖小程序使用说明

本项目是一个微信小程序，用于连接 ESP32 蓝牙模块，实现跌倒检测、本地播报及亲属远程监控功能。

## 1. 目录结构

```
smart-cane-miniprogram/
  ├── app.js            # 全局逻辑，初始化云开发
  ├── app.json          # 全局配置
  ├── app.wxss          # 全局样式
  ├── pages/
  │   ├── index/        # 首页（身份选择）
  │   ├── elder/        # 老人端（蓝牙连接与检测）
  │   └── family/       # 亲属端（远程查看状态）
```

## 2. 快速开始

1.  **导入项目**：
    *   打开微信开发者工具。
    *   选择“导入项目”，目录选择本文件夹 `smart-cane-miniprogram`。
    *   AppID 请使用你自己的小程序 AppID（测试号也可以，但云开发功能受限）。

2.  **开通云开发**（关键步骤）：
    *   在开发者工具工具栏点击“云开发”按钮。
    *   按照提示开通云开发环境（免费版即可）。
    *   获取环境 ID，填入 `app.js` 中的 `env: 'your-env-id'` 处。
    *   **创建数据库集合**：
        *   进入云开发控制台 -> 数据库。
        *   点击“+”号，创建一个新的集合，名称必须为 `cane_status`。
        *   将该集合的权限设置为“所有用户可读，仅创建者可读写”或“所有用户可读写”（为了测试方便，建议先设为所有用户可读写）。

3.  **修改蓝牙配置**：
    *   打开 `pages/elder/elder.js`。
    *   找到 `startScan` 函数中的过滤逻辑。
    *   确保你的 ESP32 蓝牙广播名称包含 "ESP32" 或 "Cane"，或者修改代码中的过滤条件以匹配你的设备名称。
    *   如果你的 ESP32 使用了特定的服务 UUID，建议在 `getServices` 函数中进行精确匹配。

## 3. 功能说明

### 老人端
*   **蓝牙连接**：点击“搜索并连接拐杖”，自动连接名为 "ESP32" 或 "Cane" 的设备。
*   **状态监测**：实时接收硬件发来的“跌倒”或“呼救”信号，触发报警并同步云端。
*   **生活助手**：
    *   **天气播报**：点击按钮或通过硬件语音指令，查询并播报天气。
    *   **新闻联播**：支持手机播放或发送文本给硬件进行 TTS 播报。
*   **吃药提醒**：接收亲属设置的提醒，并通过硬件语音播报。

### 亲属端
*   **状态监控**：查看老人当前状态（正常/跌倒/呼救）。
*   **AI 健康助手**：点击“生成 AI 健康报告”，模拟 AI 分析老人近期状态并给出建议。
*   **贴心管家**：设置定时吃药提醒，时间一到，老人端的硬件会自动播报。

## 4. 硬件通信协议 (关键)

为了配合本小程序，请按以下协议编写 ESP32 代码：

### 1. 硬件 -> 小程序 (Notify)
ESP32 通过蓝牙 Notify 特征值发送字符串指令：
*   `FALL` 或 `01`: 检测到跌倒 -> 小程序报警。
*   `HELP` 或 `SOS`: 检测到语音呼救 -> 小程序报警。
*   `NEWS`: AI 模块听到“播放新闻” -> 小程序获取新闻并处理。
*   `WEATHER`: AI 模块听到“天气查询” -> 小程序获取天气并处理。

### 2. 小程序 -> 硬件 (Write)
小程序会向 ESP32 写入字符串（分包发送，每包20字节）：
*   `TTS:文本内容`: 请求硬件进行语音合成播报。
    *   例如：`TTS:请注意，吃降压药`
    *   例如：`TTS:今天北京天气晴...`

## 5. 快速上手步骤

1.  **云开发配置**：
    *   在 `app.js` 填入环境 ID。
    *   在云控制台创建两个集合：`cane_status` (存状态), `cane_reminders` (存提醒)。
    *   权限设置为“所有用户可读写”。

2.  **硬件烧录**：
    *   编写 ESP32 代码，读取防跌倒模块和 AI 模块串口数据。
    *   实现蓝牙 BLE 服务，UUID 需与小程序匹配（默认扫描所有）。
    *   实现上述通信协议。

3.  **运行测试**：
    *   使用真机预览小程序。
    *   进入“老人端”连接蓝牙。
    *   尝试触发硬件跌倒信号，或在“亲属端”添加一个一分钟后的提醒。

## 6. 注意事项
*   **蓝牙分包**：小程序发送长文本（如新闻）时会自动分包，ESP32 端需要将接收到的碎片拼接后再发给 AI 模块，或者直接透传（如果 AI 模块支持流式接收）。

