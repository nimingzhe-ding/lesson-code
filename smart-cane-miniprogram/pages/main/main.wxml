<view class="test-page">
  <!-- é¡¶éƒ¨ Tab åˆ‡æ¢ -->
  <view class="tab-header">
    <view class="tab-item {{currentTab === 'elder' ? 'tab-active' : ''}}" bindtap="switchTab" data-tab="elder">
      <text class="tab-icon">ğŸ‘´</text>
      <text class="tab-text">è€äººç«¯</text>
      <view class="tab-indicator" wx:if="{{currentTab === 'elder'}}"></view>
    </view>
    <view class="tab-item {{currentTab === 'family' ? 'tab-active' : ''}}" bindtap="switchTab" data-tab="family">
      <text class="tab-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</text>
      <text class="tab-text">äº²å±ç«¯</text>
      <view class="tab-indicator" wx:if="{{currentTab === 'family'}}"></view>
    </view>
  </view>

  <!-- ==================== è€äººç«¯è§†å›¾ ==================== -->
  <scroll-view scroll-y class="page-content" wx:if="{{currentTab === 'elder'}}">
    <!-- ç»‘å®šç æ˜¾ç¤º -->
    <view class="info-bar">
      <text class="info-label">ç»‘å®šç :</text>
      <text class="info-value">{{bindingCode}}</text>
      <view class="ble-status {{connected ? 'ble-on' : 'ble-off'}}">
        <view class="ble-dot"></view>
        <text>{{connected ? 'è“ç‰™å·²è¿æ¥' : 'è“ç‰™æœªè¿æ¥'}}</text>
      </view>
    </view>

    <!-- è®¾å¤‡è¿æ¥å¡ç‰‡ -->
    <view class="section-card">
      <view class="card-header">
        <text class="card-icon">ğŸ“±</text>
        <text class="card-title">è®¾å¤‡è¿æ¥</text>
      </view>
      
      <view wx:if="{{scanning}}" class="connect-hint">
        <text>ğŸ” æ­£åœ¨æœç´¢æ™ºèƒ½æ‹æ–...</text>
      </view>
      <view wx:elif="{{!connected}}" class="connect-hint">
        <text>ç‚¹å‡»æŒ‰é’®æœç´¢æ™ºèƒ½æ‹æ– (Smart_Cane_ESP32)</text>
      </view>
      <view wx:else class="connect-info">
        <text class="info-text">âœ… ESP32 æ™ºèƒ½æ‹æ–å·²è¿æ¥</text>
      </view>
      
      <button class="action-btn {{connected ? 'btn-danger' : 'btn-primary'}}" 
              bindtap="{{connected ? 'disconnect' : 'startScan'}}"
              disabled="{{scanning}}"
              loading="{{scanning}}">
        {{connected ? 'æ–­å¼€è¿æ¥' : (scanning ? 'æœç´¢ä¸­...' : 'æœç´¢è¿æ¥')}}
      </button>
    </view>

    <!-- è­¦æŠ¥æ˜¾ç¤ºåŒºåŸŸ -->
    <view class="alert-card {{alertType === 'fall' ? 'alert-fall' : 'alert-gait'}}" wx:if="{{isFall || isGaitAlert}}">
      <view class="alert-header">
        <text class="alert-icon">{{alertType === 'fall' ? 'ğŸš¨' : 'âš ï¸'}}</text>
        <text class="alert-type">{{alertType === 'fall' ? 'è·Œå€’æ£€æµ‹è­¦æŠ¥' : 'æ­¥æ€å¼‚å¸¸è­¦æŠ¥'}}</text>
      </view>
      <view class="alert-message">
        <text>{{eventMessage}}</text>
      </view>
      <view class="alert-time">
        <text>è­¦æŠ¥æ—¶é—´: {{alertTime || 'åˆšåˆš'}}</text>
      </view>
      <button class="action-btn btn-dismiss" bindtap="dismissAlarm">
        ğŸ”• è§£é™¤è­¦æŠ¥
      </button>
    </view>

    <!-- å®æ—¶çŠ¶æ€ -->
    <view class="section-card status-card" wx:if="{{!isFall && !isGaitAlert}}">
      <view class="card-header">
        <text class="card-icon">ğŸ’“</text>
        <text class="card-title">å®æ—¶çŠ¶æ€ (è·Œå€’æ£€æµ‹å§‹ç»ˆå¼€å¯)</text>
      </view>
      <view class="status-display">
        <text class="status-emoji">{{connected ? 'âœ…' : 'ğŸ“´'}}</text>
        <text class="status-text">{{connected ? 'ç›‘æ§ä¸­ï¼Œä¸€åˆ‡æ­£å¸¸' : 'è¯·å…ˆè¿æ¥è®¾å¤‡'}}</text>
      </view>
    </view>

    <!-- åŠŸèƒ½çŠ¶æ€ -->
    <view class="section-card" wx:if="{{connected}}">
      <view class="card-header">
        <text class="card-icon">ğŸ®</text>
        <text class="card-title">åŠŸèƒ½çŠ¶æ€ (æ‘‡æ†æ§åˆ¶)</text>
      </view>
      <view class="mode-row">
        <view class="mode-item {{gaitEnabled ? 'mode-on' : ''}}">
          <text class="mode-icon">ğŸš¶</text>
          <text>æ­¥æ€æ£€æµ‹</text>
          <text class="mode-status">{{gaitEnabled ? 'ON' : 'OFF'}}</text>
        </view>
        <view class="mode-item {{obstacleEnabled ? 'mode-on' : ''}}">
          <text class="mode-icon">ğŸš§</text>
          <text>é¿éšœæ¨¡å¼</text>
          <text class="mode-status">{{obstacleEnabled ? 'ON' : 'OFF'}}</text>
        </view>
      </view>
    </view>

    <!-- æ­¥æ€æ•°æ® -->
    <view class="section-card" wx:if="{{connected}}">
      <view class="card-header">
        <text class="card-icon">ğŸš¶</text>
        <text class="card-title">æ­¥æ€ç›‘æµ‹</text>
        <view class="score-badge {{gaitData.score >= 80 ? 'score-good' : (gaitData.score >= 60 ? 'score-warn' : 'score-bad')}}">
          {{gaitData.score}}åˆ†
        </view>
      </view>
      
      <!-- æ­¥æ€çŠ¶æ€æç¤º -->
      <view class="gait-status-bar {{gaitData.riskLevel}}" wx:if="{{gaitData.status !== 'æ­£å¸¸'}}">
        <text>âš ï¸ {{gaitData.status}}</text>
      </view>
      
      <view class="step-count-row">
        <text class="step-icon">ğŸ‘Ÿ</text>
        <text class="step-value">{{stepCount}}</text>
        <text class="step-label">æ­¥</text>
      </view>
      <view class="data-grid">
        <view class="data-item">
          <text class="data-value">{{gaitData.stepFreq}}</text>
          <text class="data-label">æ­¥é¢‘(æ­¥/åˆ†)</text>
        </view>
        <view class="data-item">
          <text class="data-value">{{gaitData.instability}}%</text>
          <text class="data-label">æ³¢åŠ¨æ€§</text>
        </view>
        <view class="data-item">
          <text class="data-value">{{obstacleCount}}</text>
          <text class="data-label">éšœç¢æŠ¥è­¦</text>
        </view>
      </view>
      
      <!-- é‡ç½®æŒ‰é’® -->
      <button class="action-btn btn-secondary" bindtap="resetGaitData">
        é‡ç½®æ•°æ®
      </button>
    </view>

    <!-- è®¾å¤‡æ—¥å¿— -->
    <view class="section-card">
      <view class="card-header">
        <text class="card-icon">ğŸ“‹</text>
        <text class="card-title">è®¾å¤‡æ—¥å¿—</text>
        <text class="clear-log" bindtap="clearLog">æ¸…ç©º</text>
      </view>
      <scroll-view scroll-y class="log-box">
        <text class="log-text">{{log}}</text>
      </scroll-view>
    </view>
  </scroll-view>

  <!-- ==================== äº²å±ç«¯è§†å›¾ ==================== -->
  <scroll-view scroll-y class="page-content" wx:if="{{currentTab === 'family'}}">
    <!-- è€äººç«¯çŠ¶æ€ -->
    <view class="info-bar family-bar">
      <text class="info-label">ç›‘æ§è€äºº:</text>
      <text class="info-value">{{bindingCode}}</text>
      <view class="online-status {{elderOnline ? 'online' : 'offline'}}">
        <view class="online-dot"></view>
        <text>{{elderOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}}</text>
      </view>
    </view>

    <!-- äº²å±ç«¯è­¦æŠ¥æ˜¾ç¤ºåŒºåŸŸ -->
    <view class="alert-card {{familyAlertType === 'fall' ? 'alert-fall' : 'alert-gait'}}" wx:if="{{familyIsFall || familyIsGaitAlert}}">
      <view class="alert-header">
        <text class="alert-icon">{{familyAlertType === 'fall' ? 'ğŸš¨' : 'âš ï¸'}}</text>
        <text class="alert-type">{{familyAlertType === 'fall' ? 'è·Œå€’æ£€æµ‹è­¦æŠ¥' : 'æ­¥æ€å¼‚å¸¸è­¦æŠ¥'}}</text>
      </view>
      <view class="alert-message">
        <text>{{familyEventMessage}}</text>
      </view>
      <view class="alert-time">
        <text>è­¦æŠ¥æ—¶é—´: {{familyAlertTime || 'åˆšåˆš'}}</text>
      </view>
      <button class="action-btn btn-dismiss" bindtap="dismissFamilyAlarm">
        ğŸ”• è§£é™¤è­¦æŠ¥
      </button>
    </view>

    <!-- å®æ—¶ç›‘æ§ -->
    <view class="section-card status-card {{remoteStatus === 'fall' ? 'card-alert' : ''}}">
      <view class="card-header">
        <text class="card-icon">ğŸ“¡</text>
        <text class="card-title">å®æ—¶ç›‘æ§</text>
      </view>
      <view class="status-display">
        <text class="status-emoji">{{remoteStatus === 'fall' ? 'ğŸš¨' : (elderOnline ? 'âœ…' : 'ğŸ“´')}}</text>
        <text class="status-text">{{remoteStatus === 'fall' ? 'ç´§æ€¥æŠ¥è­¦ï¼' : (elderOnline ? 'è€äººçŠ¶æ€æ­£å¸¸' : 'ç­‰å¾…è€äººç«¯ä¸Šçº¿')}}</text>
      </view>
      <text class="update-time">æ›´æ–°: {{lastUpdateTime || '--'}}</text>
    </view>

    <!-- å¥åº·ä»ªè¡¨ç›˜ -->
    <view class="section-card">
      <view class="card-header">
        <text class="card-icon">ğŸ“Š</text>
        <text class="card-title">å¥åº·ç›‘æµ‹</text>
      </view>
      <view class="health-grid">
        <view class="health-item {{gaitStatus === 'æ­£å¸¸' ? '' : 'item-warn'}}">
          <text class="health-icon">ğŸš¶</text>
          <text class="health-label">æ­¥æ€</text>
          <text class="health-value">{{gaitStatus}}</text>
        </view>
        <view class="health-item">
          <text class="health-icon">ğŸš§</text>
          <text class="health-label">é¿éšœ</text>
          <text class="health-value">{{obstacleStatus}}</text>
        </view>
        <view class="health-item">
          <text class="health-icon">â¤ï¸</text>
          <text class="health-label">å¿ƒç‡</text>
          <text class="health-value">{{heartRateStatus}}</text>
        </view>
        <view class="health-item">
          <text class="health-icon">ğŸ”‹</text>
          <text class="health-label">ç”µé‡</text>
          <text class="health-value">{{batteryStatus}}</text>
        </view>
      </view>
    </view>

    <!-- æ­¥æ€è¯¦æƒ… -->
    <view class="section-card">
      <view class="card-header">
        <text class="card-icon">ğŸš¶</text>
        <text class="card-title">æ­¥æ€åˆ†æ</text>
        <view class="score-badge {{familyGaitScore >= 80 ? 'score-good' : (familyGaitScore >= 60 ? 'score-warn' : 'score-bad')}}">
          {{familyGaitScore}}åˆ†
        </view>
      </view>
      
      <!-- æ­¥æ€çŠ¶æ€æç¤º (å¼‚å¸¸æ—¶æ˜¾ç¤º) -->
      <view class="gait-status-bar {{familyRiskLevel}}" wx:if="{{familyGaitStatus !== 'æ­£å¸¸'}}">
        <text>âš ï¸ {{familyGaitStatus}}</text>
      </view>
      
      <view class="step-count-row">
        <text class="step-icon">ğŸ‘Ÿ</text>
        <text class="step-value">{{familyStepCount}}</text>
        <text class="step-label">ä»Šæ—¥æ­¥æ•°</text>
      </view>
      <view class="data-grid">
        <view class="data-item">
          <text class="data-value">{{familyStepFreq}}</text>
          <text class="data-label">æ­¥é¢‘(æ­¥/åˆ†)</text>
        </view>
        <view class="data-item">
          <text class="data-value">{{familyInstability}}%</text>
          <text class="data-label">æ³¢åŠ¨æ€§</text>
        </view>
        <view class="data-item">
          <text class="data-value">{{familyObstacleCount}}</text>
          <text class="data-label">éšœç¢æŠ¥è­¦</text>
        </view>
      </view>
      <view class="risk-bar {{familyRiskLevel}}">
        <text>é£é™©ç­‰çº§: {{familyRiskLevel === 'normal' ? 'å®‰å…¨' : (familyRiskLevel === 'warning' ? 'æ³¨æ„' : 'å±é™©')}}</text>
      </view>
    </view>

    <!-- å†å²è¯„åˆ†è®°å½• -->
    <view class="section-card">
      <view class="card-header">
        <text class="card-icon">ğŸ“ˆ</text>
        <text class="card-title">å†å²è¯„åˆ†</text>
        <view class="history-toggle" bindtap="toggleHistory">
          <text>{{showHistory ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
        </view>
      </view>
      
      <!-- ç»Ÿè®¡æ‘˜è¦ -->
      <view class="history-summary">
        <view class="summary-item">
          <text class="summary-value">{{todayScoreCount}}</text>
          <text class="summary-label">ä»Šæ—¥è®°å½•</text>
        </view>
        <view class="summary-item">
          <text class="summary-value {{averageScore >= 80 ? 'score-good-text' : (averageScore >= 60 ? 'score-warn-text' : 'score-bad-text')}}">{{averageScore}}</text>
          <text class="summary-label">å¹³å‡è¯„åˆ†</text>
        </view>
        <view class="summary-item">
          <text class="summary-value">{{scoreHistory.length}}</text>
          <text class="summary-label">æ€»è®°å½•æ•°</text>
        </view>
      </view>
      
      <!-- å†å²è®°å½•åˆ—è¡¨ -->
      <scroll-view scroll-y class="history-list" wx:if="{{showHistory}}">
        <view class="history-empty" wx:if="{{scoreHistory.length === 0}}">
          <text>æš‚æ— å†å²è®°å½•</text>
        </view>
        <view class="history-item {{item.riskLevel}}" wx:for="{{scoreHistory}}" wx:key="id">
          <view class="history-time">
            <text class="history-date">{{item.date}}</text>
            <text class="history-clock">{{item.time}}</text>
          </view>
          <view class="history-data">
            <text class="history-score {{item.score >= 80 ? 'score-good-text' : (item.score >= 60 ? 'score-warn-text' : 'score-bad-text')}}">{{item.score}}åˆ†</text>
            <text class="history-detail">æ­¥é¢‘:{{item.stepFreq}} | æ³¢åŠ¨:{{item.instability}}%</text>
          </view>
          <view class="history-status">
            <text class="status-dot {{item.riskLevel}}"></text>
          </view>
        </view>
      </scroll-view>
      
      <!-- æ¸…ç©ºæŒ‰é’® -->
      <view class="history-actions" wx:if="{{showHistory && scoreHistory.length > 0}}">
        <button class="action-btn btn-secondary" bindtap="clearHistory">æ¸…ç©ºå†å²è®°å½•</button>
      </view>
    </view>

    <!-- AI åˆ†æ -->
    <view class="section-card ai-section">
      <view class="card-header">
        <text class="card-icon">ğŸ¤–</text>
        <text class="card-title">AI å¥åº·åŠ©æ‰‹</text>
        <view class="clear-btn" bindtap="clearChat" wx:if="{{chatHistory.length > 0}}">
          <text>æ¸…ç©º</text>
        </view>
      </view>
      
      <!-- å¿«æ·é—®é¢˜ -->
      <view class="quick-questions">
        <view class="quick-btn" bindtap="quickAsk" data-question="å¦‚ä½•é¢„é˜²è€äººè·Œå€’ï¼Ÿ">é¢„é˜²è·Œå€’</view>
        <view class="quick-btn" bindtap="quickAsk" data-question="è€äººåº”è¯¥å¦‚ä½•é”»ç‚¼èº«ä½“ï¼Ÿ">é”»ç‚¼å»ºè®®</view>
        <view class="quick-btn" bindtap="quickAsk" data-question="æ­¥æ€ä¸ç¨³è¯¥æ€ä¹ˆåŠï¼Ÿ">æ­¥æ€æ”¹å–„</view>
        <view class="quick-btn" bindtap="quickAsk" data-question="å¦‚ä½•æé«˜è€äººå®‰å…¨æ„è¯†ï¼Ÿ">å®‰å…¨æŒ‡å—</view>
      </view>

      <!-- èŠå¤©è®°å½• -->
      <scroll-view class="chat-container" scroll-y="true" scroll-into-view="chat-bottom">
        <!-- é»˜è®¤æ¬¢è¿è¯­ -->
        <view class="chat-message ai-message" wx:if="{{chatHistory.length === 0}}">
          <view class="avatar ai-avatar">ğŸ¤–</view>
          <view class="message-content">
            <text>æ‚¨å¥½ï¼æˆ‘æ˜¯AIå¥åº·åŠ©æ‰‹ï¼Œå¯ä»¥ä¸ºæ‚¨è§£ç­”å…³äºè€äººæ­¥æ€ã€å¥åº·ã€å®‰å…¨ç­‰é—®é¢˜ã€‚æ‚¨å¯ä»¥ç‚¹å‡»ä¸Šæ–¹å¿«æ·é—®é¢˜ï¼Œæˆ–ç›´æ¥è¾“å…¥é—®é¢˜ã€‚</text>
          </view>
        </view>
        
        <!-- èŠå¤©è®°å½• -->
        <view class="chat-message {{item.role === 'user' ? 'user-message' : 'ai-message'}}" 
              wx:for="{{chatHistory}}" wx:key="index">
          <view class="avatar {{item.role === 'user' ? 'user-avatar' : 'ai-avatar'}}">
            {{item.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}}
          </view>
          <view class="message-content">
            <text>{{item.content}}</text>
          </view>
        </view>
        
        <!-- åŠ è½½ä¸­ -->
        <view class="chat-message ai-message" wx:if="{{asking}}">
          <view class="avatar ai-avatar">ğŸ¤–</view>
          <view class="message-content typing">
            <text>æ­£åœ¨æ€è€ƒä¸­</text>
            <view class="typing-dots">
              <text class="dot">.</text>
              <text class="dot">.</text>
              <text class="dot">.</text>
            </view>
          </view>
        </view>
        
        <view id="chat-bottom"></view>
      </scroll-view>

      <!-- è¾“å…¥åŒºåŸŸ -->
      <view class="chat-input-area">
        <input class="chat-input" 
               placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." 
               value="{{userQuestion}}"
               bindinput="onQuestionInput"
               confirm-type="send"
               bindconfirm="askAI"/>
        <button class="send-btn" bindtap="askAI" disabled="{{asking || !userQuestion}}">
          å‘é€
        </button>
      </view>

      <!-- å¥åº·æŠ¥å‘ŠæŒ‰é’® -->
      <button class="action-btn btn-ai" bindtap="analyzeHealth" loading="{{analyzing}}">
        {{analyzing ? 'åˆ†æä¸­...' : 'ğŸ“Š ç”Ÿæˆä»Šæ—¥å¥åº·æŠ¥å‘Š'}}
      </button>
    </view>
  </scroll-view>
</view>
