<view class="container">
  <!-- 未绑定状态 -->
  <view class="card" wx:if="{{!myBindingCode}}">
    <view class="title">绑定老人</view>
    <view style="margin-bottom: 30rpx; color: #666; text-align: center;">
      请输入老人端显示的6位绑定码
    </view>
    <input class="input-box" type="number" placeholder="请输入6位绑定码" bindinput="bindInput" maxlength="6" style="text-align: center; font-size: 40rpx; letter-spacing: 10rpx;"/>
    <button class="btn-primary" bindtap="confirmBind">确认绑定</button>
  </view>

  <!-- 已绑定状态 -->
  <view wx:else style="width: 100%;">
    <view class="card">
      <view class="title">亲属管控</view>
      <view style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20rpx;">
        <text style="color: #666;">已绑定: {{myBindingCode}}</text>
        <text style="color: #f44336; font-size: 28rpx;" bindtap="unbind">解除绑定</text>
      </view>
      
      <view class="status-box {{remoteStatus === 'fall' ? 'fall-bg' : 'normal-bg'}}">
        <text class="status-label">当前状态</text>
        <text class="status-value">{{statusText || (remoteStatus === 'fall' ? '异常报警' : '正常')}}</text>
        <view wx:if="{{remoteStatus === 'fall'}}" style="margin-top: 10rpx; font-size: 28rpx; background: rgba(0,0,0,0.2); padding: 5rpx 15rpx; border-radius: 10rpx;">
          <text>⚠️ 报警状态：蜂鸣器已触发</text>
        </view>
        <text class="time-label">更新时间: {{lastUpdateTime}}</text>
      </view>

      <button class="btn-primary" bindtap="refreshStatus">刷新状态</button>
    </view>

    <!-- AI 分析模块 -->
    <view class="card">
    <view class="title">AI 健康助手</view>
    <view class="ai-box">
      <view wx:if="{{!aiResult}}" class="ai-placeholder">
        点击下方按钮，AI 将根据设备数据分析老人健康状况
      </view>
      <view wx:else class="ai-result">
        <text style="font-weight: bold; color: #2196F3;">AI 分析报告：</text>
        <text>\n{{aiResult}}</text>
      </view>
    </view>
    <button class="btn-ai" bindtap="analyzeHealth" loading="{{analyzing}}">
      {{analyzing ? '正在分析中...' : '生成 AI 健康报告'}}
    </button>
  </view>

  <!-- AI 对话模块 -->
  <view class="card">
    <view class="title">AI 智能问答</view>
    <scroll-view scroll-y="true" class="chat-history" scroll-into-view="{{scrollToView}}">
      <block wx:for="{{chatHistory}}" wx:key="index">
        <view class="chat-msg {{item.role === 'user' ? 'msg-user' : 'msg-ai'}}" id="msg-{{index}}">
          <view class="msg-bubble">
            <text>{{item.content}}</text>
          </view>
        </view>
      </block>
      <view wx:if="{{chatLoading}}" class="chat-msg msg-ai">
        <view class="msg-bubble">
          <text>正在思考中...</text>
        </view>
      </view>
    </scroll-view>
    
    <view class="chat-input-area">
      <view class="voice-toggle" bindtap="toggleVoiceMode">
        <text>{{isVoiceMode ? '⌨️' : '🎤'}}</text>
      </view>
      
      <view wx:if="{{isVoiceMode}}" class="voice-btn {{recording ? 'recording' : ''}}" bindtouchstart="startRecord" bindtouchend="stopRecord">
        <text>{{recording ? '松开 结束' : '按住 说话'}}</text>
      </view>
      
      <input wx:else class="chat-input" placeholder="询问关于老人的健康问题..." value="{{chatInput}}" bindinput="onChatInput" bindconfirm="sendChatMessage"/>
      
      <button class="btn-send" bindtap="sendChatMessage" disabled="{{chatLoading}}">发送</button>
    </view>
  </view>

  <!-- 亲情设置模块 -->
  <view class="card">
    <view class="title">贴心管家</view>
    
    <!-- 吃药提醒设置 -->
    <view class="section-title">吃药提醒设置</view>
    <view class="input-group">
      <picker mode="time" value="{{remindTime}}" bindchange="bindTimeChange">
        <view class="picker">
          提醒时间: {{remindTime || '点击选择'}}
        </view>
      </picker>
      <input class="input-box" placeholder="输入提醒内容(如:吃降压药)" bindinput="bindContentInput" value="{{remindContent}}"/>
      <button class="btn-small" bindtap="addReminder">添加提醒</button>
    </view>

    <view class="reminder-list">
      <view class="reminder-item" wx:for="{{reminders}}" wx:key="_id">
        <text>{{item.time}} - {{item.content}}</text>
        <text class="delete-btn" bindtap="deleteReminder" data-id="{{item._id}}">删除</text>
      </view>
    </view>
  </view>
  </view>
</view>